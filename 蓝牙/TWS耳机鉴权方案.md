# TWS耳机鉴权方案



## 0x1 Qmii方案比较

### 1. 应用场景

Qmii：硬件发出声波--->App端解析鉴权--->鉴权成功，合法设备--->展示专辑

TWS耳机：耳机发出扫描/回复报文--->手机端连接并进行鉴权--->鉴权成功，合法设备--->开始进行数据交换--->循环交换数据



## 0x2 方案通用性分析

### 2.1 Qmii：

- 传输数据单一。每次只需要传输固定的SN和MusicSalt，不同的SN和MusicSalt代表不同数字专辑；
- 每次数据传输过程会进行加解密，摘要计算。Qmii会对SN进行加盐，非对称加密和计算摘要处理，最终服务端进行解密，得到数字专辑对应SN。



### 2.2 TWS耳机：

- 私有协议内容丰富，可传输数据量众多
- 只需要在鉴权阶段确认身份，后续传输数据阶段不需要进行复杂的加解密过程。



### 2.3 总结：

- 蓝牙设备通信大多使用私有协议，可传输数据量种类很多，并且对实时性要求很高。Qmii方案只能满足单一数据传输，并且每次和手机端通信都要通过服务端解密，验证，时间周期会很长，显然不满足需求；
- BLE协议已经有比较完善的鉴权方案，下面会给出方案具体流程。



## 0x3 TWS耳机鉴权方案

### 3.1 加密算法

加密算法采用椭圆曲线 Diffie-Hellman 密钥交换 (ECDH)。

**WHY?**

椭圆曲线密码(Elliptic Curve Cryptography, ECC)是近期备受关注的公钥密码算法。它的特点是比 RSA 所需的密钥长度短。**椭圆曲线密码密钥短但强度高**。密钥长度 224 - 255 比特的椭圆曲线密码，与密钥长度为 2048 比特的 RSA 具备相同的长度。

由于 ECC 密钥具有很短的长度，所以运算速度比较快。到目前为止，对于 ECC 进行逆操作还是很难的，数学上证明不可破解，ECC 算法的优势就是性能和安全性高。实际应用可以结合其他的公开密钥算法形成更快、更安全的公开密钥算法，比如结合 DH 密钥形成 ECDH 密钥协商算法，结合数字签名 DSA 算法组成 ECDSA 数字签名算法。

### 3.2 前期准备

ECC私钥和公钥，私钥保存在服务端，公钥保存在耳机端。

### 3.3 简写解释

P：密文

M：明文

PID：Product ID，耳机产品ID

T：时间戳

PriKeyA：ECC算法私钥，预先分配

PubKeyA：ECC算法公钥，预先分配

PriKeyB：临时私钥，耳机端生成

PubKeyB：临时公钥，耳机端生成

DHKey：共享密钥，以PubKeyA和PriKeyB生成24 Byte密钥



### 3.4 鉴权流程

![IMG_0603](/Users/faterap/Downloads/IMG_0603.PNG)



鉴权步骤：

1. ECC椭圆曲线使用FIPS 186-2 中的 P-192；

2. 预先分配一对ECC私钥（PriKeyA，24Byte）和公钥（PubKeyA，48 Byte），私钥保存在服务端，公钥保存在耳机端；

3. 开始鉴权时，App向耳机发送数据，下发4 Byte的当前时间戳T

4. 耳机产生24 Byte随机数作为临时私钥（PriKeyB），并产生对应的临时公钥（PubKeyB，48 Byte）；

5. 耳机通过ECDH算法，以PubKeyA和PriKeyB生成24 Byte密钥DHKey，并截取其前16 Byte作为AES密钥（AesKey）;

6. 耳机再生成8 Byte随机数R，依次拼接组合PID、T、R、蓝牙MAC地址，成为22 Byte明文M，通过后补0的方式补齐明文M到32 Byte；

7. 耳机再以AesKey对M加密，产生32 Byte密文P；

8. 耳机向App发送数据，把PID（4 Byte明文）、PubKeyB（48 Byte）和P（32 Byte）回传到App；

9. App把上述数据连同T，上传到服务端；

10. 服务端使用PriKeyA、PubKeyB产生DHKey，同样截取出AesKey，并解密P，得到M；

11. 服务端依次校对时间戳T及MAC地址，若均合法，则鉴权成功，向App返回随机数R；否则返回错误码。

### 3.5 方案总结

优点：

- 使用椭圆曲线 Diffie-Hellman 密钥交换算法，可保证数据的加密性，防止其它人窃听数据
- ECC对比RSA有以下的优势：加密速度快，效率更高，对服务器资源消耗低，而且最重要的是更安全，抗攻击型更强。尤其BLE协议中每次传输数据量有限，用ECC算法可以节省数据量，加快数据通信效率

缺点：

- ECDH对于`篡改`和`伪装`（即中间人攻击，MITM）无能为力，若要解决这些问题，需使引入消息认证码（MAC）或者数字签名技术。但这样的话会极大增加计算量和方案复杂度，在蓝牙设备通讯范畴内可以暂不做考虑。

