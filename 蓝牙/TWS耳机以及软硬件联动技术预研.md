# TWS耳机以及软硬件联动技术预研

## TWS耳机现状

### 核心技术

- 主动降噪
- 传感交互（压力传感，心率传感器...）
- BLE Audio（含音频共享，双耳同时连接，高品质音乐传输等等）

![截屏2021-03-25 上午12.06.34](/Users/faterap/Library/Application Support/typora-user-images/截屏2021-03-25 上午12.06.34.png)

### 品牌

目前市面上主流的TWS耳机品牌有苹果、三星、华为、小米、OPPO、vivo、魅族等，此外还有传统的音频设备厂商Sony、漫步者、森海塞尔、JBL、Bose、Beats等等，主要来自智能手机品牌商的智能终端周边产品以及传统音频产品制造商的业务延伸。当然，还有一些数码设备厂商（比如Anker、倍思、JEET）和一些语音技术厂商（比如出门问问）。

### 芯片

2016年6月，蓝牙技术联盟正是发布了新的蓝牙5.0标准，而蓝牙5.0针对低功耗设备，并且有着更广的覆盖范围，相比之前的4.2BLE有着四倍覆盖范围，速度上也提升了两倍，达到了2Mbps。可以说，蓝牙5.0非常适合TWS耳机的需求。

2017年，相关的蓝牙5.0芯片及设备开始上市，2018年，多数的智能手机新机都开始支持蓝牙5.0标准，渗透速度较所有前期蓝牙技术都要快。而这也直接推动了对于支持蓝牙5.0标准的TWS耳机的需求。

因此，各大芯片厂商也纷纷顺应趋势，推出了一系列支持蓝牙5.0标准的TWS无线蓝牙耳机芯片。

目前市场上TWS耳机芯片供应商主要有高通（CSR）、恒玄（BES）、络达（Airoha）、瑞昱（REALTEK）、炬芯（Actions）、艾迈斯（ams）、紫光展锐、原相、杰理等。苹果采用的是自己的Apple H1芯片。

以下是部分支持蓝牙5.0的TWS芯片：

![img](https://pic3.zhimg.com/80/v2-82e42a83d7e78c56fb942fe06898038a_1440w.jpg)

### 工作原理

#### Apple独家

2017-2018 年 蓝牙技术传输方案还不成熟，各大厂商都在集中解决 TWS 耳机蓝牙断连、延迟等蓝牙技术传输问题。苹果AirPods采用独家的Snoop（监听）专利技术解决了双耳连接延迟不同步问题，即便售价昂贵也得到了消费者的认可，销售量逐年翻番。

苹果AirPods的Snoop技术，副耳信号不需要主耳转发，而是通过一定的规则监听手机所发出的信号，从接收信号中找出主耳或者副耳各自的信号，因此解决了转发所带来的干扰、系统延迟、主副耳功耗不均衡等问题，获得了很好的用户体验。

#### 其他厂商早期技术

移动装置连接主耳机，再由主耳机通过蓝牙无线方式连接副耳机组成立体声系统，实现真正的蓝牙左右声道无线分离使用。由于TWS耳机左右单元没有物理线材连接，所以TWS耳机一般不采用micro USB接口方式充电，而是通过配备便携式充电盒以提供充电和收纳功能。

传统的安卓系方案早期采用Relay（转发）模式，通过主耳转发的方式实现双耳立体声，音频从智能手机传到左耳机（主设备），再由左耳机转发到右耳机（从设备）。但却面临如下问题：主耳转发的蓝牙信号容易被其它蓝牙和WiFi等信号干扰；转发本身会增加系统延迟；转发信号穿过人的身体等问题。此外，由于转发导致了主耳的功耗相比副耳要高，当碰上误码要求重传数据包时会导致主耳功耗负载过重。以上原因导致苹果之外的TWS 耳机在连接稳定性、主副耳机的信号同步以及待机的时长等方面面临很多问题，这也是这几年安卓系TWS 耳机无法跟AirPods相提并论的主要原因。

![640.png](https://aijishu.com/img/bVQLO)

#### 后期改良

但随着高通TWS+和络达科技MCSync的相继发布，安卓阵营TWS耳机可以实现左右声道独立连接，其蓝牙连接性能向苹果AirPods看齐。

![img](https://pic3.zhimg.com/80/v2-252d43035b82048dbca591e44f221e02_1440w.jpg)

### 方案比较

![截屏2021-03-25 上午12.10.00](/Users/faterap/Library/Application Support/typora-user-images/截屏2021-03-25 上午12.10.00.png)

### 组成结构

TWS耳机主要由充电盒部分与无线耳机部分组成，其中充电盒包括锂电池包、电源PCB组件、电池管理IC、LED充电指示灯模块等器件，无线耳机部分包括芯片（如蓝牙芯片、电源管理芯片等）、传感器（如加速度传感器、距离传感器等）、电池、麦克风及其他电子器件。
![image.png](https://aijishu.com/img/bVQLU)

### 与传统蓝牙耳机对比

![image.png](https://aijishu.com/img/bVQLW)

### 蓝牙芯片厂商

![image.png](https://aijishu.com/img/bVQMd)

**主控蓝牙芯片行业市场竞争格局：根据市场定位分类，蓝牙主控芯片市场可分为以下三个梯队：**

（1）**中高端市场**参与者主要有苹果、高通、华为海思等厂商；

（2）**中低端市场**参与者主要有恒玄科技、络达科技、瑞昱、紫光展锐等；

（3）**低端市场**参者者主要包括杰里科技、中科蓝讯等。除了苹果和华为海思（主要为自家产品供货），目前独立蓝牙芯片供应市场形成的C（CRS高通）、B（BES恒玄）、A（Airoha络达）的**“CBA”格局**，其中高通的CSR系列芯片市场占有率最高。

目前市场主流的TWS耳机主控蓝牙芯片包括苹果H1芯片、华为海思麒麟A1芯片、高通QCC5100系列芯片、恒玄BES系列芯片、络达AB1536芯片等。

#### ![image.png](https://aijishu.com/img/bVQMe)



### TWS耳机硬件要求

- 支持蓝牙 5.0 以上 （非强制，体验更好），对应系统版本Android 8.0以上



## 市面TWS耳机芯片现状

### 手机厂商

1. 华为：
- FreeBuds 3：华为海思（麒麟A1）
- Freebuds 2 Pro: 恒玄科技（BES2300）
- 其他：炬芯（ATS300X）

2. OPPO：

- OPPO O-FREE: 高通（QCC5100）

3. VIVO:

- VIVO TWS Earphone: 高通（QCC5100）

3. 小米：
- 小米 Air dot：恒玄科技（BES2300）
- 小米 Air dot（青春版）： 瑞昱（RTL8773C）

4. 华强北厂商：络达科技（AB1536），瑞昱（RTL8773C）



### Q音竞品

网易云：

- 网易云音乐氧气真无线耳机LITE：炬芯（ATS3005）

酷狗：

-  酷狗X5 真无线蓝牙耳机：高通（QCC3026）

### 总结

- 海思（麒麟A1）：高端，华为自家可用
- 高通（QCC5100）：高端，OPPO/VIVO/Bose/Sony/JBL
- 恒玄科技（BES2300）：中高端， 华为/小米/魅族
- 瑞昱（RTL8773C）：低端， 小米/华强北
- 络达科技（AB1536）：低端，华强北
- 炬芯（ATS300X）：低端，华为



## 竞品调研

### 网易

网易云音乐真无线蓝牙耳机：

- 具备实体按键，单击网易云收藏歌曲，双击跳转至每日推荐，网易云专属

### 酷狗

酷狗真无线蓝牙耳机x5：

- 语音点歌，酷狗音乐专属

### 华米OV

TWS耳机与手机系统有深层次的定制，对自家系统依赖性比较高，若与其他品牌配对，功能受限

- TWS耳机在自家手机上连接/配对，均有专属动画
- 语音唤醒自家语音助手
- 厂商个性化定制功能（如华为耳道检测）

### 总结

- 网易和酷狗在自家App上做了细微定制化功能，如一键收藏，智能点歌，但仅适配自家耳机；技术方案应该是通过蓝牙私有协议实现，方案下面会想输
- 华米OV等手机厂商，均在系统层面进行适配自家耳机，实现定制化功能；除了TWS耳机自身特有传感器相关功能，其他功能比较类似（如配对动画，语音助手唤等）



## 技术实现方案

#### 整体流程

蓝牙BLE发现TWS耳机 -->设备鉴权--->设备品牌确认--->赋予相应权益

![截屏2021-03-24 下午11.21.09](/Users/faterap/Library/Application Support/typora-user-images/截屏2021-03-24 下午11.21.09.png)

#### 发现设备

每次QQ音乐启动时，或接收到蓝牙设备连接的系统广播时，Q音会通过TWS耳机特定的UUID，检查当前已连接设备是否协议下的注册设备，如果是的话，会尝试与设备进行BLE连接。

连接建立成功后，Q音会发起握手鉴权，鉴权成功后才能使用其他功能；鉴权失败将断开连接。

#### 设备鉴权

蓝牙安全管理方面，市面上已经有一套比较完整，安全的体系，技术方案可参考蓝牙牛方案：

![image-20210324235320936](/Users/faterap/Library/Application Support/typora-user-images/image-20210324235320936.png)

1)  【120】鉴权过程

1. ECC椭圆曲线使用FIPS 186-2 中的 P-192；

2.  预先分配一对ECC私钥（PriKeyA，24Byte）和公钥（PubKeyA，48 Byte），私钥保存在云端，公钥保存在设备端；

3.  开始鉴权时，APP发起【120】请求，向设备下发4 Byte的当前时间戳T；

4.  设备产生24 Byte随机数作为临时私钥（PriKeyB），并产生对应的临时公钥（PubKeyB，48 Byte）；

5. 设备通过ECDH算法，以PubKeyA和PriKeyB生成24 Byte密钥DHKey，并截取其前16 Byte作为AES密钥（AesKey）；
6. 设备再生成8 Byte随机数R，依次拼接组合PID（4）、T（4）、R（8）、蓝牙MAC（6），成为22 Byte明文M，通过后补0的方式补齐明文M到32 Byte；
7. 设备再以AesKey对M加密，产生32 Byte密文P；

8.  设备向APP发送【120】回复，把PID（4 Byte明文）、PubKeyB（48 Byte）和P（32 Byte）回传到APP；

9.  APP把上述数据连同T，上传到云端；
10.  云端使用PriKeyA、PubKeyB产生DHKey，同样截取出AesKey，并解密P，得到M；

11. 云端依次校对时间戳T及Mac地址，若均合法，则鉴权成功，向APP返回随机数R；否则返回错误码。



2)  【121】反向鉴权流程：

设备从【121】请求中读出随机数R，与自身之前生成的随机数R做匹配，如完全一致则回复【121】成功；如不一致则回复【121】失败，回复码 = 13，然后断开连接。



### 品牌确认

私有协议中可以设定若干字段，表示TWS耳机所属厂商，所属型号等硬件相关信息。



### 权益赋予

蓝牙设备UUID可作为等同于Q音内部账号体系，可根据设备UUID，若命中特定TWS耳机，则赋予不同权益（绿钻，数字专辑等等）



### 可拓展性

Q音私有协议中通过不同字段，表示TWS耳机各维度相关信息，如PCM数据，各传感器信息等，进行更多品牌/用户定制化开发的功能，功能上会有很大的想象空间，例如：

- TWS耳机获得蓝牙音乐管家同等体验，如语音点歌，歌曲搜索，语音切割，音量调节等语音唤醒功能
- 根据不同TWS耳机自身传感器，可获得耳机各维度信息，如骨声纹传感器可识别用户身份，压力传感器可得知用户当前手势，心率传感器可获取用户体征等等各方面的信息。Q音若能整合以上传感器内容，可根据TWS耳机品牌型号，实现用户定制化开发功能。比如根据不同耳机品牌，用户耳道形状，实现定制化音效等等



### 总结

- 各手机厂商和Q音各持有一套公钥私钥，公钥进行数据加密，数字签名校验，私钥用于数据解密，确保TWS耳机设备通过鉴权认证
- TWS耳机侧需要发送耳机唯一标识符，QQ音乐通过BLE扫描，获取耳机相关信息，然后对耳机设备鉴权认证。身份确认后根据耳机品牌，赋予不同权益或解锁特有功能。



厂商需要做的

- 提供唯一标识符，表示耳机相关信息（厂商，品牌，型号...）
- 根据Q音私有协议，发送加解密相关数据，进行身份认证鉴权



![IMG_D49A8242142F-1](/Users/faterap/Downloads/IMG_D49A8242142F-1.jpeg)





https://aijishu.com/a/1060000000163738 一文看懂中国TWS耳机全产业链

[https://zhuanlan.zhihu.com/p/347137534] TWS耳机的开挂人生

https://pdf.dfcfw.com/pdf/H3_AP202007271394534611_1.pdf?1595872702000.pdf TWS耳机2020年调研报告

