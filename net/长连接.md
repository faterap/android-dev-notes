# 长连接

## 长连接与短连接

这两者分别对应的是 `TCP 协议层` 的`长连接 `和`短连接`。

大家都知道，TCP 会通过三次握手，建立与服务端的连接，然后传递数据，只不过 `短连接 `在数据传输完后，会主动关闭连接，而 `长连接 `会继续保持这条连接，后续的数据读写继续使用这条连接。

### 长连接 vs Http 的 `Keep-Alive`

通过 Http1.1 的`Keep Alive` 字段，我们可以让一条 Http 连接保持不被立即关闭。有些同学这时就疑惑了，是不是长连接就是 `Keep Alive` 呢？

其实不是的。长连接我们也叫 `TCP 长连接`，它是架设在 TCP 协议上的，而上面说的`Keep Alive` 是 Http 协议的内容，连协议都不同，两者自然不是一个东西。

### TCP 的 `Keep-Alive` vs Http 的`Keep-Alive`

提到 `Keep Alive`，有些同学就会问了，TCP 协议里也有一个`Keep Alive`，它和 Http 协议里的`Keep Alive` 有什么区别吗？

二者的用处并不同。Http 协议在完成一个请求后，服务器会自动关闭连接。这时，可以在请求里带上一个 `Keep Alive` 给服务器，告诉 `服务器不要立即关闭连接 `，我还想继续复用这条连接；而对 TCP 协议层而言，是不会自动断开的，但这也带来了一个问题，万一由于某些外部原因导致连接断开，那我如何知道连接已失效呢？TCP 会在 2 个小时间隔后，自动发送一个`Keep Alive` 数据包给服务端，探测一下服务器是否还在响应。它的功能类似心跳包，只是间隔太长，不适合做真正的心跳包。

## 为什么需要长连接

那么，相比 Http 短连接，长连接技术能带来什么好处呢？

1. 不同域名的请求可以复用同一个长连接通道

以前我们不同域名的请求，需要做对应的 DNS 请求，然后建立对应的 Http 连接。上篇文章里说的 `Http 连接池` 在不同域名下不可复用，需要重新建立连接。这些都是一些资源开销，但是如果通过长连接通道，那域名只是这个请求里的一个字段，可以直接复用同一条长连接通道。

2. 不依赖 DNS，无 DNS 耗时和劫持等问题

长连接都是 IP 直接连接，因此没有 DNS 相关的开销和耗时。

3. 如果有大量网络请求，可以明显减少网络延时，节省带宽

对于大型 App 而言，存在繁多密集的网络请求，这中间就会存在非常多次的 Http 断开和重新连接，浪费了很多时间和带宽。而通过长连接通道的话，则没有这部分耗时，直接传输二进制数据即可，节省了每次连接里 Header 之类的带宽开销。

4. 服务端主动 Push 数据到客户端

对于上面提到的微信消息接收等场景，如果需要客户端主动去轮询，则会频繁发起请求，对于服务器会产生很大的负载压力，浪费带宽流量。而通过长连接，服务端可以主动把消息下发给客户端，做到最高实时性，且节省流量。