# Objective- C 动态性

### 1. 编译时和运行时

编译时： 即编译器对语言的编译阶段，编译时只是对语言进行最基本的检查报错，包括词法分析、语法分析等等，将程序代码翻译成计算机能够识别的语言（例如汇编等），编译通过并不意味着程序就可以成功运行。

运行时： 即程序通过了编译这一关之后编译好的代码被装载到内存中跑起来的阶段，这个时候会具体对类型进行检查，而不仅仅是对代码的简单扫描分析，此时若出错程序会崩溃。

可以说编译时是一个静态的阶段，类型错误很明显可以直接检查出来，可读性也好；而运行时则是动态的阶段，开始具体与运行环境结合起来。

### 2. 动态性

#### 2.1. 含义

OC语言的动态性主要体现在三个方面：动态类型(Dynamic typing)、动态绑定(Dynamic binding)和动态加载(Dynamic loading)。

#### 2.2动态类型

动态类型指的是对象指针类型的动态性，具体是指使用id任意类型将对象的类型确定推迟到运行时，由赋给它的对象类型决定对象指针的类型。另外类型确定推迟到运行时之后，可以通过NSObject的isKindOfClass方法动态判断对象最后的类型（动态类型识别）。也就是说id修饰的对象为动态类型对象，其他在编译器指明类型的为静态类型对象，通常如果不需要涉及到多态的话还是要尽量使用静态类型（原因上面已经说到：错误可以在编译器提前查出，可读性好）。

示例：

对于语句NSString* testObject = [[NSData alloc] init]; testObject在编译时和运行时分别是什么类型的对象？
首先testObject是一个指向某个对象的指针，不论何时指针的空间大小是固定的。

编译时： 指针的类型为NSString，即编译时会被当成一个NSString实例来处理，编译器在类型检查的时候如果发现类型不匹配则会给出黄色警告，该语句给指针赋值用的是一个NSData对象，则编译时编译器则会给出类型不匹配警告。但编译时如果testObject调用NSString的方法编译器会认为是正确的，既不会警告也不会报错。

运行时： 运行时指针指向的实际是一个NSData对象，因此如果指针调用了NSString的方法，虽然编译时通过了，但运行时会崩溃，因为NSData对象没有该方法；另外，虽然运行时指针实际指向的是NSData，但编译时编译器并不知道（前面说了编译器会把指针当成NSString对象处理），因此如果试图用这个指针调用NSData的方法会直接编译不通过，给出红色报错，程序也运行不起来。

#### 2.3 动态绑定

动态绑定指的是方法确定的动态性，具体指的是利用OC的消息传递机制将要执行的方法的确定推迟到运行时，可以动态添加方法。也就是说，一个OC对象是否调用某个方法不是由编译器决定的，而是由运行时决定的；另外关于动态绑定的关键一点是基于消息传递机制的消息转发机制，主要处理应对一些接受者无法处理的消息，此时有机会将消息转发给其他接收者处理，具体见下面介绍。

动态绑定是基于动态类型的，在运行时对象的类型确定后，那么对象的属性和方法也就确定了(包括类中原来的属性和方法以及运行时动态新加入的属性和方法)，这也就是所谓的动态绑定了。动态绑定的核心就该是在运行时动态的为类添加属性和方法，以及方法的最后处理或转发，主要用到C语言语法，因为涉及到运行时，因此要引入运行时头文件：#include <objc/runtime.h>。

消息传递机制：

在OC中,方法的调用不再理解为对象调用其方法，而是要理解成对象接收消息，消息的发送采用‘动态绑定’机制，具体会调用哪个方法直到运行时才能确定，确定后才会去执行绑定的代码。方法的调用实际就是告诉对象要干什么，给对象(的指针)传送一个消息，对象为接收者（receiver），调用的方法及其参数即消息（message），给一个对象传消息表达为：[receiver message]; 接受者的类型可以通过动态类型识别于运行时确定。

在消息传递机制中，当开发者编写[receiver message];语句发送消息后，编译器都会将其转换成对应的一条objc_msgSend C语言消息发送原语，具体格式为： 
void objc_msgSend (id self, SEL cmd, ...)

这个原语函数参数可变，第一个参数填入消息的接受者，第二个参数是消息‘选择子’，后面跟着可选的消息的参数。有了这些参数，objc_msgSend就可以通过接受者的的isa指针，到其类对象中的方法列表中以选择子的名称为‘键’寻找对应的方法，找到则转到其实现代码执行，找不到则继续根据继承关系从父类中寻找，如果到了根类还是无法找到对应的方法，说明该接受者对象无法响应该消息，则会触发‘消息转发机制’，给开发者最后一次挽救程序崩溃的机会。

#### 2.4 动态加载

动态加载主要包括两个方面，一个是动态资源加载，一个是一些可执行代码模块的加载，这些资源在运行时根据需要动态的选择性的加入到程序中，是一种代码和资源的‘懒加载’模式，可以降低内存需求，提高整个程序的性能，另外也大大提高了可扩展性。

例如：资源动态加载中的图片资源的屏幕适配，同一个图片对象可能需要准备几种不同分辨率的图片资源，程序会根据当前的机型动态选择加载对应分辨率的图片，像iphone4之前老机型使用的是@1x的原始图片，而retina显示屏出现之后每个像素点被分成了四个像素，因此同样尺寸的屏幕需要4倍分辨率（宽高各两倍）的@2x图片，最新的针对iphone6/6+以上的机型则需要@3x分辨率的图片。例如下面所示应用的AppIcon，需要根据机型以及机型分辨率动态的选择加载某张具体的图片资源：

