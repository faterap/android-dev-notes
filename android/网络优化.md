# 网络优化

### 1. 问题现状

**▼ 首先：是网络不可用问题。主要由以下几种原因导致：**

- 1）GFW的拦截，原因你懂的；
- 2）DNS的劫持，端口的意外封禁等；
- 3）偏远地区网络基础设施比较差。

**▼ 其次：是网络加载时间长问题。这些原因包括：**

- 1）移动设备出于省电的目的，发出网络请求前需要先预热通信芯片；
- 2）网络请求需要跨网络运营商，物理路径长；
- 3）HTTP请求是基于Socket设计的，请求发起之前会经历三次握手，断开时又会进行四次挥手。

**▼ 最后：是HTTP协议的数据安全问题。具体的原因有：**

- 1）HTTP协议的数据容易被抓包；
- 2）Post包体数据经过加密能够避免泄露，但协议中的URL和header部分还是会暴露给抓包软件（HTTPS也面临相似的问题）；
- 3）运营商数据恶意篡改严重。



### 2. 优化策略

#### 2.1 短连接优化

##### 2.1.1 域名合并

![img](https://segmentfault.com/img/remote/1460000022781640)

该方案的核心思想在于：保持客户端业务层代码编写的网络请求与后端业务服务器收到的请求保持一致，请求发出前，在客户端网络层对域名收编，请求送入后端，在SLB（Server Load Balancing）中对域名进行还原。

**该方案具有如下优势：**

- 1）域名得到了收编，减少了DNS调用次数，降低了DNS劫持风险；
- 2）针对同一域名，可以利用Keep-Alive来复用Http的连接；
- 3）客户端业务层不需要修改代码，后端业务服务也不需要进行任何修改。



##### 2.1.2 IP直连

**IP直连方案有下面几大优势：**

- 1）摒弃了系统DNS，减少外界干扰，摆脱DNS劫持困扰；
- 2）自建DNS更新时机可以控制；
- 3）IP列表更换方便。

另外，IP直连方案对HTTPS中证书的处理需要注意：HTTPS由于要求证书绑定域名，如果做IP直连方案可能会遇到一些麻烦，这时我们需要对客户端的HTTPS的域名校验部分进行改造，参见《[https信任证书的三种方式](https://link.segmentfault.com/?enc=6UNPKBX0S3r3vuiFV0uvpA%3D%3D.3%2FuUEfTxRHuSa54xn4ykbxi4I5fFyosUvduoV2u3m1bXjTipEwqJ9Xk%2BuEuR3j84LL0jNfHBvMTXCPGAdpAoFg%3D%3D)》 。

经过域名合并加上IP直连方案改造后，HTTP短连的端到端成功率从95%提升到97.5%，网络延时从1500毫秒降低到了1000毫秒，可谓小投入大产出。



#### 2.2 长连接通道

##### 2.2.1 普通长连接

HTTP/2在客户端与服务器之间建立长连通道，将同一域名的请求都放在长连通道上进行。这种拓扑结构有如下一些缺点： 1. 请求基于DNS，仍将面临DNS劫持风险。 2. 不同域名的请求需要建立多条连接。 3. 网络通道难以优化。客户端与服务器之间是公网链路。如果在多地部署服务器，成本消耗又会很大。 4. 业务改造难度大。部署HTTP/2，需要对业务服务器进行改造，而且使用的业务服务器越多，需要改造的成本也越大。 5. 网络协议可订制程度小。

![6](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/3ae12edc.png)

##### 2.2.2 代理长连接（WNS）

与HTTP/2相区别，我们这里推荐另一种代理长连的模式。

![7](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/3c1a3802.png)

基本思路为：在客户端与业务服务器之间架设代理长连服务器，客户端与代理服务器建立TCP长连通道，客户端的HTTP请求被转换为了TCP通道上的二进制数据包。代理服务器负责与业务服务器进行HTTP请求，请求的结果通过长连通道送回客户端。

与HTTP/2模式对比，代理长连模式具有下面一些优势： 1. 对DNS无依赖。客户端与代理服务器之间的长连通道是通过IP建立的，与DNS没有关系。客户端的HTTP请求被转换为二进制数据流送到代理服务器，也不需要进行DNS解析。代理服务器转发请求到业务服务器时，都处于同一内网，因此可以自己搭建DNS服务，减少对公网DNS服务的依赖。从这个层面上说，代理长连模式天生具有防DNS劫持的能力。 2. 不同域名的请求可以复用同一条长连通道。 3. 通道易优化。与部署业务服务器相比，部署代理长连服务器的代价就小了很多，可以在全国甚至全世界多地部署代理长连服务器。客户端在选择代理长连服务器时，可以通过跑马找到最快的服务器IP进行连接。另一方面，代理服务器与业务服务器之间的网络通道也可以进行优化，通过架设专线或者租用腾讯云等方式可以大大提升通道服务质量。 4. 对业务完全透明。客户端的业务代码只要接入网络层的SDK即可，完全不用关心网络请求使用的是长连通道还是短连通道。代理服务器将客户端的请求还原为HTTP短连方式送到业务服务器，业务服务器不需要进行任何改造。 5. 网络协议完全自定义。





https://segmentfault.com/a/1190000022781635
