# 密码安全总结

## 0x1 加密算法

### 1.1 对称加密算法



### 1.2 非对称加密算法

**公钥密码** (public-key cryptography)则是指在加密和解密时使用不同密钥的方式。对应的加密方式是非对称加密。目前广泛使用 RSA。公钥密码解决了密钥配送的问题，但是存在通过中间人攻击被伪装的风险，因此需要对带有数字签名的公钥进行认证。

#### RSA算法

##### - RSA 加密

在 RSA 中，明文、密钥和密文都是数字。加密过程可以用下面的公式来表示：

```c
密文 = 明文^E mod N
```

RSA 的密文是对代表明文的数字 E 次方求 mod N 的结果。E 和 N 是 RSA 加密的密钥，**E 和 N 的组合就是公钥**。E 是加密 Encryption 的首字母，N 是数字 Number 的首字母。

##### - RSA 解密

RSA 解密过程可以用下面的公式来表示：

```c
明文 = 密文^D mod N
```

解密的过程是对密文的数字的 D 次方求 mod N 就可以得到明文。**D 和 N 的组合就是私钥**。D 是解密 Decryption 的首字母，N 是数字 Number 的首字母。

RSA 奇妙的是加密和解密过程是一致的。加密是求明文的 E 次方对 N 的 mod 余数。解密是求密文的 D 次方对 N 的 mod 余数。



### 1.3 椭圆曲线加密算法

椭圆曲线密码(Elliptic Curve Cryptography, ECC)是近期备受关注的公钥密码算法。它的特点是比 RSA 所需的密钥长度短。**椭圆曲线密码密钥短但强度高**。密钥长度 224 - 255 比特的椭圆曲线密码，与密钥长度为 2048 比特的 RSA 具备相同的长度。

#### i 椭圆曲线 Diffie-Hellman 密钥交换 (ECDH)

DH 算法和 RSA 算法最大的不同在于：

- DH 算法在进行**密钥协商**的过程中，通信双方的任何一方无法独自计算出一个会话密钥，通信双方各自保留一部分关键信息，再将另外一部分信息告诉对方，双方有了全部信息才能共同计算出全部的会话密钥。	
- RSA 算法在传输会话密钥的时候，会话密钥完全由客户端生成和控制，并没有服务端的参与，准确的来说应该叫 **RSA 密钥传输**。



##  0x2 密钥配送问题

### 2.1 事先共享密钥

### 2.2 密钥分配中心

### 2.3 Diffie-Hellman 密钥交换

为了解决集中式管理的缺点，那么应该密钥的配送还是不能用集中式。于是有人想出了 Diffie-Hellman 密钥交换的方法。

在 Diffie-Hellman 密钥交换中，加密通信双方需要交换一些信息，而这些信息即便被窃听者窃听，也不会有任何问题。

根据交换的信息，双方各自生成相同的密钥。而窃听者无法生成相同的密钥。这种方式可行。**不过这种方式不算是非对称加密**，在本文中不详细讨论。

### 2.4 公钥密码

非对称加密有一个公钥和一个私钥。公钥可以在网上传播，被窃听者拿到也没有关系，由于没有私钥，他也无法解开密文。私钥只要掌握在接收者手上就不会导致密文被窃听。

举个例子：超市里面的存包处，所有顾客有硬币就可以存包。硬币就是“公钥”，顾客把包放进箱子里，（明文加密），箱子锁上以后就没人能打开。这个时候窃听者也拿不走存进去的包。这个明文（包），只有私钥才能打开。客户存完包以后会生成一个私钥，只要这个钥匙在手，就可以随时开箱拿包。





## 0x3 BLE密码安全

BLE面临的威胁有：`窃听`、`篡改`和`伪装`，对应的安全特性为：`机密性`、`一致性`、`是否已认证`。

“威胁”和“安全特性”的关系可以这样描述：

- 如果消息没有加密，消息则不具有机密性，无法防止他人窃听；
- 如果发送者发送的消息和接收者的消息是不同的，说明消息被篡改过，不具有一致性；
- 如果没有对消息进行认证，无法保证消息来自正确发送者而不是伪装者。



### 3.1 对称密码

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/SymmetricCryptography.png)



对称密码技术可以解决`窃听`的威胁，但是有一个前提，就是在这之前发送者和接收者要有相同的密钥key，所以一定要先给接收者配送密钥，有以下几种方式：

1. Bob通过网络先将key发送给Alice，但容易被Eve截取到；
2. Bob乘坐交通工具将密钥key亲手交给Alice，或者其他网络以外的方式配送密钥，这种方式成本高维护麻烦，称为带外（Out-Of-Band）配送；
3. 用diffie-hellman密钥交换算法解决；
4. 用椭圆曲线diffie-hellman密钥交换算法解决。



### 3.2 diffie-hellman密钥交换算法

在DH中，我们将Y称为公钥（public key），将x称为私钥（private key），则有以下结论：已知G、p、公钥的时候，很难求出私钥。

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/DH.png)

**diffie-hellman密钥交换算法解决的问题**

因为DH密钥交换算法利用了“离散对数问题”的复杂度，所以就算Eve一直窃听，Bob和Alice也能协商出一个共享密钥，而Eve却因为复杂的数学问题而没办法算出共享密钥，也就解决了对称密码中的配送问题。



### 3.3 椭圆曲线diffie-hellman密钥交换算法

DH是利用了“离散对数问题”的复杂度来实现密钥的安全交换的，如果将“离散对数问题”改为“椭圆曲线上的离散对数问题”，这样的算法就叫椭圆曲线diffie-hellman密钥交换（ECDH）。

两者密钥交换总体流程相同，只是利用的数学问题不同而已，ECDH能够用较短的密钥长度实现较高的安全性。

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/ECDH.png)



**椭圆曲线diffie-hellman密钥交换算法无法解决的问题**

DH和ECDH都能解决密钥配送问题，结合对称密码技术，就能保证消息的机密性，防止被`窃听`了，但是对于`篡改`和`伪装`的攻击，却无能为力。为了解决剩下这两个威胁，就要靠其他技术手段了。



![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/tamper.png)

如上图所示，Mallory不需要知道密文是什么意思，但是他可以修改密文，导致Alice解密出预期以外的内容。

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/camouflage.png)



### 3.4 消息认证码

消息认证码（MAC）技术是检查信息一致性并进行认证的技术，发送者通过MAC算法可以输出一个MIC值，接收者通过校验MIC值不仅可以判断消息一致性，还能判断消息是否来自正确的发送者。

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/MAC.png)

MAC技术有以下几种重要性质：

- 正向快速：给定明文、MAC算法和密钥key，在有限时间和有限资源内能计算出MIC。
- 逆向困难：给定MIC、MAC算法和明文，在有限时间内很难（基本不可能）逆推出密钥。
- 输入敏感：原始输入信息修改一点信息，产生的MIC看起来应该都有很大不同。
- 冲突避免：很难找到两段内容不同的明文，使得它们的MIC一致（发生冲突）。即对于任意两个不同的数据块，其MIC相同的可能性极小；对于一个给定的数据块，找到和它MIC相同的数据块极为困难。

MAC技术与对称加密技术有一个显著差异：加密解密是双向的，可以互相推导，而认证只能单向；加密是为了解密，MAC设计是无法解。

**消息认证码解决的问题**

消息经过CMAC算法之后，为何Mallory无法篡改消息和伪装呢？

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/authentication.png)

- Mallory如果想篡改明文，那就同时也要篡改MIC，否则无法通过Alice的校验，但是应该将MIC改成多少呢？因为Malloyr没有共享密钥，所以他也不知道MIC应该是什么。如果想篡改MIC，那就同时也要篡改明文才能通过Alice的校验，由于MAC算法的逆向困难性质，Mallory不知道明文应该是什么。
- Bob用CMAC算法认证一条消息并发给Alice，并要求Alice也用CMAC算法认证并返回一条消息给Bob。若Mallory伪装成Alice，由于没有认证密钥，无法返回通过Bob校验的消息。

**消息认证码无法解决的问题**

没错，要使用MAC技术，首先要有相同的认证密钥，又回到了之前的密钥配送问题，具体这里采用哪种方式解决配送密钥问题，视实际情况而定。

**消息认证码攻击方式**

对于MAC算法来说，应保证不能根据MIC和明文推测出通信双方所使用的密钥。但实际上用穷举法是可以推测出来的，如果使用密码学安全的、高强度的伪随机数生成器生成密钥，就会使得破解时间需要很长以至在现实中几乎不可能破解。而如果密钥是人为选定的，就会大大增加被推测出来的风险。



### 3.5 总结

![img](http://jdhblog.com/2019/05/14/BLE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/SecurityTechnology.png)

总结：

- 为了解决`窃听`问题，采用对称密码技术；
- 为了解决对称密码技术的加密密钥配送问题，采用配送密钥技术；
- 为了解决`篡改`问题，采用消息认证码技术；
- 为了解决`伪装`问题，采用消息认证码技术；
- 为了解决消息认证码技术的认证密钥配送问题，采用配送密钥技术。

> Tips：无论消息认证码技术还是对称密码技术，都需要用到配送密钥技术，而不同的配送密钥技术本身，也会涉及到认证强度的问题。比如希望用ECDH来解决消息认证码的认证密钥配送问题，但是ECDH本身认证强度为零，所以它也需要消息认证码技术来证明ECDH过程中没有出现篡改或者伪装攻击，即又要使用消息认证码技术，导致进入了死循环。所以需要选择合适的密钥配送技术，常见的有：邮箱验证码、手机短信验证码、NFC、目测法等。